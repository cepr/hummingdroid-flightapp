#!/bin/bash

OBJS="\
	libs/LSM9DS0_Breakout/Libraries/Arduino/SFE_LSM9DS0/SFE_LSM9DS0.o \
	Communication.pb.o \
	Motors.o \
	Telemetry.o \
	DatagramSocket.o \
	Object.o \
	Value.o \
	Receiver.o \
	FlightService.o \
	Telemetry.o \
	Sensors.o \
	Thread.o \
	Timestamp.o \
	Controller.o"

DEPENDS="${OBJS//.o/.d}"

INCLUDES="\
	libs/LSM9DS0_Breakout/Libraries/Arduino/SFE_LSM9DS0 \
	libs/protobuf/src"

function usage() {
	echo 'Usage: configure <Intel Edison SDK environment file path>'
	echo 'Generates the build files for the project.'
}

function generate_makefile() {
	echo '# This file has been autogenerated by "configure"'
	echo
	echo '.PHONY: all install clean install_service'
	echo
	echo 'ifndef OECORE_SDK_VERSION'
	echo 'all install install_service clean:'
	echo '	. '$SDK_ENV_FILE' ; $(MAKE) $(MAKECMDGOALS)'
	echo 'else'
	echo
	echo 'all: flight_software'
	echo
	for i in $DEPENDS
	do
		echo "-include $i"
	done
	echo
	echo 'CPPFLAGS+=\'
	for i in $INCLUDES
	do
		echo ' -I "'$i'" \'
	done
	echo ' -Wall \'
	echo ' -O0 \'
	echo ' -MD'
	echo
	echo 'LINK.o:=$(LINK.cpp)'
	echo
	echo 'flight_software: LDLIBS+=-lpthread -lmraa'
	echo "flight_software: $OBJS libs/protobuf/build/src/.libs/libprotobuf.a"
	echo '	$(LINK.cc) $^ $(LOADLIBES) $(LDLIBS) -o $@'
	echo
	echo 'install: flight_software'
        echo '	ssh root@drone.local ''systemctl stop hummingdroid.service'''
        echo '	scp $< root@drone.local:/home/root'
        echo '	ssh root@drone.local ''sync'''
        echo '	ssh root@drone.local ''systemctl start hummingdroid.service'''
	echo
	echo 'libs/protobuf/build/src/.libs/libprotobuf.a:'
	echo '	mkdir -p libs/protobuf/build'
	echo '	cd libs/protobuf/build && ../configure && make'
	echo
	echo 'Communication.pb.cc: Communication.proto libs/protobuf/build/src/.libs/libprotobuf.a'
	echo '	libs/protobuf/build/src/protoc --cpp_out=. Communication.proto'
	echo
	echo 'clean:'
	echo "	rm -rf flight_software libs/protobuf/build Communication.pb.h Communication.pb.cc"
	echo "	rm -rf $OBJS"
	echo "	rm -rf $DEPENDS"
	echo
	echo 'install_service:'
        echo "	ssh root@drone.local 'mkdir -p /home/root/.ssh'"
        echo "	scp $HOME/.ssh/id_rsa.pub root@drone.local:/home/root/.ssh/authorized_keys"
        echo "	scp hummingdroid.service root@drone.local:/lib/systemd/system"
        echo "	ssh root@drone.local 'systemctl enable hummingdroid.service'"
	echo
	echo 'endif'
}

SDK_ENV_FILE=$1
if [ -z "$SDK_ENV_FILE" ]
then
	usage
	exit 1
fi

if [ ! -e "$SDK_ENV_FILE" ]
then
	echo "File not found: $SDK_ENV_FILE"
	usage
	exit 1
fi

generate_makefile > Makefile
